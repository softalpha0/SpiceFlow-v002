<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SpiceFlow Admin</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f0f1a;
      color: #fff;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header { background: #ff5722; padding: 1rem; font-size: 1.5rem; font-weight: bold; }
    .container { max-width: 700px; margin: 2rem auto; padding: 1rem; }
    .card { background: #1e1e30; margin: 1rem 0; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.4); }
    input, select { padding: 8px; margin: 5px; width: 80%; border-radius: 5px; border: none; }
    button { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .btn-admin { background: #ff5722; color: white; }
    .btn-delete { background: #d32f2f; color: white; padding: 4px 8px; margin-left: 5px; border-radius: 3px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; border-bottom: 1px solid #333; }
  </style>
</head>
<body>
  <header>âš¡ SpiceFlow Admin Panel âš¡</header>
  <div class="container">

    <!-- Admin Key -->
    <div class="card">
      <h3>Enter Admin Key</h3>
      <input id="adminKey" type="password" placeholder="Admin Key" />
      <button id="loginAdmin" class="btn-admin">Unlock</button>
    </div>

    <!-- Task Manager -->
    <div id="taskManager" class="card" style="display:none;">
      <h3>Create New Task</h3>
      <input id="taskName" placeholder="Task Name" />
      <select id="taskType">
        <option value="social.like">Like</option>
        <option value="social.retweet">Retweet</option>
        <option value="social.reply">Reply</option>
        <option value="special">Follow (Special)</option>
      </select>
      <input id="taskPoints" placeholder="Points" type="number" value="100" />
      <input id="taskHref" placeholder="Task Link (Tweet/Profile URL)" />
      <button id="createTask" class="btn-admin">Create Task</button>
    </div>

    <!-- Task List -->
    <div id="tasks" class="card" style="display:none;">
      <h3>Current Tasks</h3>
      <div id="taskList"></div>
    </div>

    <!-- Leaderboard -->
    <div id="leaderboard" class="card" style="display:none;">
      <h3>Leaderboard</h3>
      <div id="lbContent"></div>
    </div>

  </div>

  <script>
    const API_BASE = "";
    let ADMIN_KEY = null;

    // ðŸ”¹ Extract tweet ID from URL
    function extractTweetId(url) {
      const match = url.match(/status\/(\d+)/);
      return match ? match[1] : null;
    }

    // ðŸ”¹ Extract username from profile URL
    function extractUsername(url) {
      const match = url.match(/x\.com\/([^\/?]+)/);
      return match ? match[1] : null;
    }

    // ðŸ”¹ Call backend API
    async function api(path, opts={}) {
      try {
        const res = await fetch(API_BASE + path, {
          headers: { "Content-Type":"application/json", "x-admin-key": ADMIN_KEY || "" },
          ...opts
        });
        if(!res.ok) throw new Error("HTTP " + res.status);
        return await res.json();
      } catch(err) {
        console.error("API Error:", err);
        return null;
      }
    }

    // ðŸ”¹ Convert username â†’ user_id using backend proxy
    async function fetchUserIdFromUsername(username) {
      const res = await api(`/api/admin/resolve-username?username=${username}`);
      if (res && res.id) return res.id;
      throw new Error("Could not resolve username: " + username);
    }

    // ðŸ”¹ Admin login
    document.getElementById("loginAdmin").onclick = () => {
      ADMIN_KEY = document.getElementById("adminKey").value.trim();
      if (!ADMIN_KEY) return alert("Enter the Admin Key");
      document.getElementById("taskManager").style.display="block";
      document.getElementById("tasks").style.display="block";
      document.getElementById("leaderboard").style.display="block";
      loadTasks();
      loadLeaderboard();
    };

   document.getElementById("createTask").onclick = async () => {
  const typeSelect = document.getElementById("taskType").value;
  let taskType = (typeSelect === "special") ? "social.follow" : typeSelect;
  let taskHref = document.getElementById("taskHref").value.trim();

  const payload = {
    name: document.getElementById("taskName").value.trim(),
    type: taskType,
    points: Number(document.getElementById("taskPoints").value),
    href: taskHref
  };

  // ðŸ”¹ Set tweet_id or target_user_id
  if (taskType === "social.like" || taskType === "social.retweet" || taskType === "social.reply") {
    payload.tweet_id = extractTweetId(taskHref);   // extract from tweet URL
    if (!payload.tweet_id) return alert("Invalid tweet URL");
  } else if (taskType === "social.follow") {
    const username = extractUsername(taskHref);   // extract from profile URL
    if (!username) return alert("Invalid profile URL");

    try {
      payload.target_user_id = await fetchUserIdFromUsername(username);  // fetch numeric ID
    } catch (err) {
      return alert("Failed to resolve username â†’ user_id");
    }
  }

  // Send to backend
  const res = await api("/api/admin/tasks", { method:"POST", body: JSON.stringify(payload) });
  if(res && res.task){
    alert("Task created!");
    document.getElementById("taskName").value="";
    document.getElementById("taskHref").value="";
    loadTasks();
  } else {
    alert("Failed to create task. Check console for details.");
  }
};


    
    // ðŸ”¹ Load tasks
    async function loadTasks() {
      const list = await api("/api/spiceflow/tasks");
      const div = document.getElementById("taskList");
      div.innerHTML = "";
      if(Array.isArray(list)){
        list.forEach(t => {
          const el = document.createElement("div");
          el.innerHTML = `
            <p><b>${t.name}</b> (${t.type}) â€¢ ${t.points} pts
            ${t.href ? `â†’ <a href="${t.href}" target="_blank">Open</a>` : ""}
            <button class="btn-delete" onclick="deleteTask(${t.id})">Delete</button></p>`;
          div.appendChild(el);
        });
      } else div.innerHTML = "<p>No tasks loaded.</p>";
    }

    // ðŸ”¹ Delete task
    async function deleteTask(id){
      if(!confirm("Are you sure?")) return;
      const res = await api("/api/admin/tasks/" + id, { method:"DELETE" });
      if(res && res.message) { alert("Task deleted!"); loadTasks(); }
      else alert("Failed to delete task.");
    }

    // ðŸ”¹ Load leaderboard
    async function loadLeaderboard() {
      const data = await api("/api/spiceflow/leaderboard");
      const div = document.getElementById("lbContent");
      if(Array.isArray(data)){
        let html = "<table><tr><th>User</th><th>Points</th></tr>";
        data.forEach(u => { html += `<tr><td>${u.username}</td><td>${u.points}</td></tr>`; });
        html += "</table>";
        div.innerHTML = html;
      } else div.innerHTML = "<p>No leaderboard data.</p>";
    }
  </script>
</body>
</html>

